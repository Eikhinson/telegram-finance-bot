{"version":3,"file":"hono-streaming.mjs","sources":["../../node_modules/hono/dist/utils/stream.js","../../node_modules/hono/dist/helper/streaming/utils.js","../../node_modules/hono/dist/helper/streaming/stream.js"],"sourcesContent":["// src/utils/stream.ts\nvar StreamingApi = class {\n  writer;\n  encoder;\n  writable;\n  abortSubscribers = [];\n  responseReadable;\n  /**\n   * Whether the stream has been aborted.\n   */\n  aborted = false;\n  /**\n   * Whether the stream has been closed normally.\n   */\n  closed = false;\n  constructor(writable, _readable) {\n    this.writable = writable;\n    this.writer = writable.getWriter();\n    this.encoder = new TextEncoder();\n    const reader = _readable.getReader();\n    this.abortSubscribers.push(async () => {\n      await reader.cancel();\n    });\n    this.responseReadable = new ReadableStream({\n      async pull(controller) {\n        const { done, value } = await reader.read();\n        done ? controller.close() : controller.enqueue(value);\n      },\n      cancel: () => {\n        this.abort();\n      }\n    });\n  }\n  async write(input) {\n    try {\n      if (typeof input === \"string\") {\n        input = this.encoder.encode(input);\n      }\n      await this.writer.write(input);\n    } catch {\n    }\n    return this;\n  }\n  async writeln(input) {\n    await this.write(input + \"\\n\");\n    return this;\n  }\n  sleep(ms) {\n    return new Promise((res) => setTimeout(res, ms));\n  }\n  async close() {\n    try {\n      await this.writer.close();\n    } catch {\n    }\n    this.closed = true;\n  }\n  async pipe(body) {\n    this.writer.releaseLock();\n    await body.pipeTo(this.writable, { preventClose: true });\n    this.writer = this.writable.getWriter();\n  }\n  onAbort(listener) {\n    this.abortSubscribers.push(listener);\n  }\n  /**\n   * Abort the stream.\n   * You can call this method when stream is aborted by external event.\n   */\n  abort() {\n    if (!this.aborted) {\n      this.aborted = true;\n      this.abortSubscribers.forEach((subscriber) => subscriber());\n    }\n  }\n};\nexport {\n  StreamingApi\n};\n","// src/helper/streaming/utils.ts\nvar isOldBunVersion = () => {\n  const version = typeof Bun !== \"undefined\" ? Bun.version : void 0;\n  if (version === void 0) {\n    return false;\n  }\n  const result = version.startsWith(\"1.1\") || version.startsWith(\"1.0\") || version.startsWith(\"0.\");\n  isOldBunVersion = () => result;\n  return result;\n};\nexport {\n  isOldBunVersion\n};\n","// src/helper/streaming/stream.ts\nimport { StreamingApi } from \"../../utils/stream.js\";\nimport { isOldBunVersion } from \"./utils.js\";\nvar contextStash = /* @__PURE__ */ new WeakMap();\nvar stream = (c, cb, onError) => {\n  const { readable, writable } = new TransformStream();\n  const stream2 = new StreamingApi(writable, readable);\n  if (isOldBunVersion()) {\n    c.req.raw.signal.addEventListener(\"abort\", () => {\n      if (!stream2.closed) {\n        stream2.abort();\n      }\n    });\n  }\n  contextStash.set(stream2.responseReadable, c);\n  (async () => {\n    try {\n      await cb(stream2);\n    } catch (e) {\n      if (e === void 0) {\n      } else if (e instanceof Error && onError) {\n        await onError(e, stream2);\n      } else {\n        console.error(e);\n      }\n    } finally {\n      stream2.close();\n    }\n  })();\n  return c.newResponse(stream2.responseReadable);\n};\nexport {\n  stream\n};\n"],"names":[],"mappings":"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","x_google_ignoreList":[0,1,2]}