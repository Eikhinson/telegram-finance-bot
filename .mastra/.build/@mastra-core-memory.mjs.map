{"version":3,"file":"@mastra-core-memory.mjs","sources":["../../node_modules/@mastra/core/dist/chunk-Z6ZIJYKK.js"],"sourcesContent":["import { augmentWithInit } from './chunk-436FFEF6.js';\nimport { MessageList } from './chunk-GIK7MM2K.js';\nimport { ModelRouterEmbeddingModel } from './chunk-72F4RGK7.js';\nimport { deepMerge } from './chunk-PPAIPZ6C.js';\nimport { MastraBase } from './chunk-VQASQG5D.js';\n\n// src/memory/memory.ts\nvar MemoryProcessor = class extends MastraBase {\n  /**\n   * Process a list of messages and return a filtered or transformed list.\n   * @param messages The messages to process\n   * @returns The processed messages\n   */\n  process(messages, _opts) {\n    return messages;\n  }\n};\nvar memoryDefaultOptions = {\n  lastMessages: 10,\n  semanticRecall: false,\n  threads: {\n    generateTitle: true\n  },\n  workingMemory: {\n    enabled: false,\n    template: `\n# User Information\n- **First Name**: \n- **Last Name**: \n- **Location**: \n- **Occupation**: \n- **Interests**: \n- **Goals**: \n- **Events**: \n- **Facts**: \n- **Projects**: \n`\n  }\n};\nvar MastraMemory = class extends MastraBase {\n  MAX_CONTEXT_TOKENS;\n  _storage;\n  vector;\n  embedder;\n  processors = [];\n  threadConfig = { ...memoryDefaultOptions };\n  #mastra;\n  constructor(config) {\n    super({ component: \"MEMORY\", name: config.name });\n    if (config.options) this.threadConfig = this.getMergedThreadConfig(config.options);\n    if (config.processors) this.processors = config.processors;\n    if (config.storage) {\n      this._storage = augmentWithInit(config.storage);\n      this._hasOwnStorage = true;\n    }\n    if (this.threadConfig.semanticRecall) {\n      if (!config.vector) {\n        throw new Error(\n          `Semantic recall requires a vector store to be configured.\n\nhttps://mastra.ai/en/docs/memory/semantic-recall`\n        );\n      }\n      this.vector = config.vector;\n      if (!config.embedder) {\n        throw new Error(\n          `Semantic recall requires an embedder to be configured.\n\nhttps://mastra.ai/en/docs/memory/semantic-recall`\n        );\n      }\n      if (typeof config.embedder === \"string\") {\n        this.embedder = new ModelRouterEmbeddingModel(config.embedder);\n      } else {\n        this.embedder = config.embedder;\n      }\n    }\n  }\n  /**\n   * Internal method used by Mastra to register itself with the memory.\n   * @param mastra The Mastra instance.\n   * @internal\n   */\n  __registerMastra(mastra) {\n    this.#mastra = mastra;\n  }\n  _hasOwnStorage = false;\n  get hasOwnStorage() {\n    return this._hasOwnStorage;\n  }\n  get storage() {\n    if (!this._storage) {\n      throw new Error(\n        `Memory requires a storage provider to function. Add a storage configuration to Memory or to your Mastra instance.\n\nhttps://mastra.ai/en/docs/memory/overview`\n      );\n    }\n    return this._storage;\n  }\n  setStorage(storage) {\n    this._storage = augmentWithInit(storage);\n  }\n  setVector(vector) {\n    this.vector = vector;\n  }\n  setEmbedder(embedder) {\n    this.embedder = embedder;\n  }\n  /**\n   * Get a system message to inject into the conversation.\n   * This will be called before each conversation turn.\n   * Implementations can override this to inject custom system messages.\n   */\n  async getSystemMessage(_input) {\n    return null;\n  }\n  /**\n   * Get tools that should be available to the agent.\n   * This will be called when converting tools for the agent.\n   * Implementations can override this to provide additional tools.\n   */\n  getTools(_config) {\n    return {};\n  }\n  async createEmbeddingIndex(dimensions, config) {\n    const defaultDimensions = 1536;\n    const isDefault = dimensions === defaultDimensions;\n    const usedDimensions = dimensions ?? defaultDimensions;\n    const separator = this.vector?.indexSeparator ?? \"_\";\n    const indexName = isDefault ? `memory${separator}messages` : `memory${separator}messages${separator}${usedDimensions}`;\n    if (typeof this.vector === `undefined`) {\n      throw new Error(`Tried to create embedding index but no vector db is attached to this Memory instance.`);\n    }\n    const semanticConfig = typeof config?.semanticRecall === \"object\" ? config.semanticRecall : void 0;\n    const indexConfig = semanticConfig?.indexConfig;\n    const createParams = {\n      indexName,\n      dimension: usedDimensions,\n      ...indexConfig?.metric && { metric: indexConfig.metric }\n    };\n    if (indexConfig && (indexConfig.type || indexConfig.ivf || indexConfig.hnsw)) {\n      createParams.indexConfig = {};\n      if (indexConfig.type) createParams.indexConfig.type = indexConfig.type;\n      if (indexConfig.ivf) createParams.indexConfig.ivf = indexConfig.ivf;\n      if (indexConfig.hnsw) createParams.indexConfig.hnsw = indexConfig.hnsw;\n    }\n    await this.vector.createIndex(createParams);\n    return { indexName };\n  }\n  getMergedThreadConfig(config) {\n    if (config?.workingMemory && \"use\" in config.workingMemory) {\n      throw new Error(\"The workingMemory.use option has been removed. Working memory always uses tool-call mode.\");\n    }\n    const mergedConfig = deepMerge(this.threadConfig, config || {});\n    if (config?.workingMemory?.schema) {\n      if (mergedConfig.workingMemory) {\n        mergedConfig.workingMemory.schema = config.workingMemory.schema;\n      }\n    }\n    return mergedConfig;\n  }\n  /**\n   * Apply all configured message processors to a list of messages.\n   * @param messages The messages to process\n   * @returns The processed messages\n   */\n  async applyProcessors(messages, opts) {\n    const processors = opts.processors || this.processors;\n    if (!processors || processors.length === 0) {\n      return messages;\n    }\n    let processedMessages = [...messages];\n    for (const processor of processors) {\n      processedMessages = await processor.process(processedMessages, {\n        systemMessage: opts.systemMessage,\n        newMessages: opts.newMessages,\n        memorySystemMessage: opts.memorySystemMessage\n      });\n    }\n    return processedMessages;\n  }\n  processMessages({\n    messages,\n    processors,\n    ...opts\n  }) {\n    return this.applyProcessors(messages, { processors: processors || this.processors, ...opts });\n  }\n  estimateTokens(text) {\n    return Math.ceil(text.split(\" \").length * 1.3);\n  }\n  /**\n   * Helper method to create a new thread\n   * @param title - Optional title for the thread\n   * @param metadata - Optional metadata for the thread\n   * @returns Promise resolving to the created thread\n   */\n  async createThread({\n    threadId,\n    resourceId,\n    title,\n    metadata,\n    memoryConfig,\n    saveThread = true\n  }) {\n    const thread = {\n      id: threadId || this.generateId(),\n      title: title || `New Thread ${(/* @__PURE__ */ new Date()).toISOString()}`,\n      resourceId,\n      createdAt: /* @__PURE__ */ new Date(),\n      updatedAt: /* @__PURE__ */ new Date(),\n      metadata\n    };\n    return saveThread ? this.saveThread({ thread, memoryConfig }) : thread;\n  }\n  /**\n   * Helper method to add a single message to a thread\n   * @param threadId - The thread to add the message to\n   * @param content - The message content\n   * @param role - The role of the message sender\n   * @param type - The type of the message\n   * @param toolNames - Optional array of tool names that were called\n   * @param toolCallArgs - Optional array of tool call arguments\n   * @param toolCallIds - Optional array of tool call ids\n   * @returns Promise resolving to the saved message\n   * @deprecated use saveMessages instead\n   */\n  async addMessage({\n    threadId,\n    resourceId,\n    config,\n    content,\n    role,\n    type,\n    toolNames,\n    toolCallArgs,\n    toolCallIds\n  }) {\n    const message = {\n      id: this.generateId(),\n      content,\n      role,\n      createdAt: /* @__PURE__ */ new Date(),\n      threadId,\n      resourceId,\n      type,\n      toolNames,\n      toolCallArgs,\n      toolCallIds\n    };\n    const savedMessages = await this.saveMessages({ messages: [message], memoryConfig: config });\n    const list = new MessageList({ threadId, resourceId }).add(savedMessages[0], \"memory\");\n    return list.get.all.v1()[0];\n  }\n  /**\n   * Generates a unique identifier\n   * @returns A unique string ID\n   */\n  generateId() {\n    return this.#mastra?.generateId() || crypto.randomUUID();\n  }\n};\n\nexport { MastraMemory, MemoryProcessor, memoryDefaultOptions };\n//# sourceMappingURL=chunk-Z6ZIJYKK.js.map\n//# sourceMappingURL=chunk-Z6ZIJYKK.js.map"],"names":[],"mappings":"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","x_google_ignoreList":[0]}